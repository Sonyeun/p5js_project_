// 1. ì „ì—­ ë³€ìˆ˜
let video;
let handpose;
let predictions = [];
let currentGesture = "ì•Œ ìˆ˜ ì—†ìŒ";

// 2. setup í•¨ìˆ˜
function setup() {
  createCanvas(400, 400);
  video = createCapture(VIDEO);
  video.size(width, height);
  video.hide();

  handpose = ml5.handpose(video, modelReady);

  handpose.on('predict', results => {
    predictions = results;
    if (predictions.length > 0) {
      defineGesture(predictions[0]);
    } else {
      currentGesture = "ì†ì´ ê°ì§€ë˜ì§€ ì•ŠìŒ";
    }
  });
}

// 3. draw í•¨ìˆ˜
function draw() {
  // ì›¹ìº  í™”ë©´ì„ ì¢Œìš° ë°˜ì „í•´ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤ (ê±°ìš¸ ëª¨ë“œ)
  translate(width, 0);
  scale(-1, 1);
  image(video, 0, 0, width, height);
  
  // ê·¸ë¦¼ê³¼ í…ìŠ¤íŠ¸ëŠ” ì •ìƒì ìœ¼ë¡œ ë³´ì´ê¸° ìœ„í•´ ë‹¤ì‹œ ì¢Œí‘œê³„ë¥¼ ì›ë˜ëŒ€ë¡œ ëŒë¦½ë‹ˆë‹¤
  translate(width, 0);
  scale(-1, 1);

  drawKeypoints();
  
  // í˜„ì¬ ì¸ì‹ëœ ì œìŠ¤ì²˜ í…ìŠ¤íŠ¸ë¥¼ ì˜¤ë¥¸ìª½ ìœ„ì— í‘œì‹œí•©ë‹ˆë‹¤
  fill(255, 0, 0);
  noStroke();
  textSize(28);
  textAlign(RIGHT, TOP);
  text(currentGesture, width - 10, 10);
}


// 4. ë³´ì¡° í•¨ìˆ˜ë“¤
function modelReady() {
  console.log("Handpose ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ!");
}

function drawKeypoints() {
  for (let i = 0; i < predictions.length; i++) {
    const prediction = predictions[i];
    for (let j = 0; j < prediction.landmarks.length; j++) {
      const keypoint = prediction.landmarks[j];
      fill(0, 255, 0);
      noStroke();
      ellipse(keypoint[0], keypoint[1], 10, 10);
    }
  }
}

function defineGesture(prediction) {
  const landmarks = prediction.landmarks;
  
  const thumbTip = landmarks[4];
  const indexTip = landmarks[8];
  const middleTip = landmarks[12];
  const ringTip = landmarks[16];
  const pinkyTip = landmarks[20];
  const palmBase = landmarks[0];
  const indexKnuckle = landmarks[5];
  const middleKnuckle = landmarks[9];
  const ringKnuckle = landmarks[13];
  const pinkyKnuckle = landmarks[17];

  // ì£¼ë¨¹ ì¥ê¸° (Fist)
  if (dist(indexTip[0], indexTip[1], palmBase[0], palmBase[1]) < 50 &&
      dist(middleTip[0], middleTip[1], palmBase[0], palmBase[1]) < 70) {
    currentGesture = "ì£¼ë¨¹ âœŠ";
    return;
  }
  
  // ì†ë°”ë‹¥ í´ê¸° (Open Palm)
  if (indexTip[1] < indexKnuckle[1] && middleTip[1] < middleKnuckle[1] &&
      ringTip[1] < ringKnuckle[1] && pinkyTip[1] < pinkyKnuckle[1]) {
    currentGesture = "ì†ë°”ë‹¥ âœ‹";
    return;
  }

  // í•€ì¹˜ (Pinch)
  if (dist(thumbTip[0], thumbTip[1], indexTip[0], indexTip[1]) < 30) {
    currentGesture = "í•€ì¹˜ ğŸ‘Œ";
    return;
  }
  
  // í¬ì¸íŒ… (Pointing)
  if (indexTip[1] < indexKnuckle[1] &&
      dist(middleTip[0], middleTip[1], palmBase[0], palmBase[1]) < 80 &&
      dist(ringTip[0], ringTip[1], palmBase[0], palmBase[1]) < 80) {
    currentGesture = "í¬ì¸íŒ… ğŸ‘‰";
    return;
  }

  currentGesture = "ì•Œ ìˆ˜ ì—†ìŒ";
}