// Handpose ëª¨ë¸ ë° ë¹„ë””ì˜¤ ê´€ë ¨ ë³€ìˆ˜
let handpose;
let video;
let predictions = [];

// ë‹¤ì´ì•„ëª¬ë“œ(ë§ˆë¦„ëª¨) ê´€ë ¨ ë³€ìˆ˜
let diamonds = [];
let spreadCount = 0; // ì œìŠ¤ì²˜ íšŸìˆ˜ ì¹´ìš´í„°

// ì œìŠ¤ì²˜ ê°ì§€ë¥¼ ìœ„í•œ ìƒíƒœ ë³€ìˆ˜
let handState = 'UNKNOWN'; // ì†ì˜ í˜„ì¬ ìƒíƒœ ('OPEN', 'CLOSED', 'UNKNOWN')
let lastHandState = 'UNKNOWN'; // ì§ì „ í”„ë ˆì„ì˜ ì† ìƒíƒœ

function setup() {
  createCanvas(windowWidth, windowHeight);
  video = createCapture(VIDEO, () => {
    // ì›¹ìº  ë¡œë”© í›„ ëª¨ë¸ ì´ˆê¸°í™”
    handpose = ml5.handpose(video, modelReady);
    handpose.on('predict', results => {
      predictions = results;
    });
  });
  video.size(640, 480);
  video.hide();
}

function modelReady() {
  console.log("Handpose ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ! ğŸ‘‹");
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}

function draw() {
  background(255);

  // 1. ì† ì œìŠ¤ì²˜ ê°ì§€ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
  updateHandState();

  // 2. ì œìŠ¤ì²˜ ìƒíƒœ ë³€í™”ì— ë”°ë¥¸ ì´ë²¤íŠ¸ ì²˜ë¦¬
  // 'ì£¼ë¨¹ ì¥” ìƒíƒœ' -> 'í¸ ìƒíƒœ'ë¡œ ë°”ë€” ë•Œ ë§ˆë¦„ëª¨ ìƒì„±
  if (handState === 'OPEN' && lastHandState !== 'OPEN') {
    spreadCount++;
    console.log(`ì† í¼ì¹¨ ê°ì§€! (${spreadCount}ë²ˆì§¸) ğŸ’`);
    generateDiamondGrid(spreadCount, predictions[0].landmarks);
  }

  // 'í¸ ìƒíƒœ' -> 'ì£¼ë¨¹ ì¥” ìƒíƒœ'ë¡œ ë°”ë€” ë•Œ ë§ˆë¦„ëª¨ ì œê±°
  if (handState === 'CLOSED' && lastHandState !== 'CLOSED') {
    console.log("ì£¼ë¨¹ ì¥  ê°ì§€! ğŸ¤");
    shrinkLatestDiamonds();
  }

  // 3. ëª¨ë“  ë§ˆë¦„ëª¨ ì—…ë°ì´íŠ¸ ë° ê·¸ë¦¬ê¸°
  updateAndDrawDiamonds();

  // í˜„ì¬ í”„ë ˆì„ì˜ ì† ìƒíƒœë¥¼ ì´ì „ ìƒíƒœë¡œ ì €ì¥
  lastHandState = handState;
}


/**
 * @brief ì†ê°€ë½ ëœë“œë§ˆí¬ë¥¼ ë¶„ì„í•˜ì—¬ í˜„ì¬ ì†ì˜ ìƒíƒœë¥¼ 'OPEN' ë˜ëŠ” 'CLOSED'ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 */
function updateHandState() {
  if (predictions.length === 0) {
    handState = 'UNKNOWN';
    return;
  }

  const landmarks = predictions[0].landmarks;
  let fingersUp = 0;

  // ê° ì†ê°€ë½ì´ í´ì¡ŒëŠ”ì§€ í™•ì¸ (ì—„ì§€ëŠ” xì¢Œí‘œ, ë‚˜ë¨¸ì§€ëŠ” yì¢Œí‘œ ê¸°ì¤€)
  if (landmarks[4][0] > landmarks[3][0]) fingersUp++;   // ì—„ì§€
  if (landmarks[8][1] < landmarks[6][1]) fingersUp++;   // ê²€ì§€
  if (landmarks[12][1] < landmarks[10][1]) fingersUp++; // ì¤‘ì§€
  if (landmarks[16][1] < landmarks[14][1]) fingersUp++; // ì•½ì§€
  if (landmarks[20][1] < landmarks[18][1]) fingersUp++; // ìƒˆë¼

  // 4ê°œ ì´ìƒì˜ ì†ê°€ë½ì´ í´ì§€ë©´ 'OPEN', 1ê°œ ì´í•˜ë©´ 'CLOSED'ë¡œ íŒë‹¨
  if (fingersUp >= 4) {
    handState = 'OPEN';
  } else if (fingersUp <= 1) {
    handState = 'CLOSED';
  } else {
    handState = 'UNKNOWN'; // ì¤‘ê°„ ìƒíƒœ
  }
}


/**
 * @brief í™”ë©´ ì „ì²´ì— ë§ˆë¦„ëª¨ë¥¼ ê²©ì í˜•íƒœë¡œ ìƒì„±í•©ë‹ˆë‹¤.
 * @param {number} id - ëª‡ ë²ˆì§¸ ì œìŠ¤ì²˜ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ ì‹ë³„í•˜ëŠ” ë²ˆí˜¸
 * @param {Array} landmarks - ì†ì˜ ëœë“œë§ˆí¬ ì¢Œí‘œ
 */
function generateDiamondGrid(id, landmarks) {
  // ì†ê°€ë½ ëì  ì‚¬ì´ì˜ ìµœëŒ€ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ì—¬ ë§ˆë¦„ëª¨ì˜ ê¸°ë³¸ í¬ê¸°ë¥¼ ì •í•¨
  let maxDistance = 0;
  for (let i = 0; i < 5; i++) {
    for (let j = i + 1; j < 5; j++) {
      const finger1 = landmarks[4 + i * 4];
      const finger2 = landmarks[4 + j * 4];
      const d = dist(finger1[0], finger1[1], finger2[0], finger2[1]);
      if (d > maxDistance) {
        maxDistance = d;
      }
    }
  }

  const diamondSize = map(maxDistance, 50, 300, 15, 50); // ìµœì†Œ 15, ìµœëŒ€ 50 í¬ê¸°ë¡œ ë§¤í•‘
  const margin = 50; // í™”ë©´ ê°€ì¥ìë¦¬ ì—¬ë°±
  
  // ë§ˆë¦„ëª¨ì˜ ì‹¤ì œ ë Œë”ë§ë  ëŒ€ê°ì„  ê¸¸ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°„ê²©ì„ ê³„ì‚°í•˜ì—¬ ê²¹ì¹˜ì§€ ì•Šë„ë¡ í•¨
  const spacing = diamondSize * 2.2; // í¬ê¸°ì˜ 2.2ë°°ë¡œ ê°„ê²© ì„¤ì •

  // í™”ë©´ ë„ˆë¹„ì™€ ë†’ì´ì— ë§ì¶° ìƒì„±ë  ë§ˆë¦„ëª¨ì˜ ê°œìˆ˜(ì—´, í–‰) ê³„ì‚°
  const cols = floor((width - margin * 2) / spacing);
  const rows = floor((height - margin * 2) / spacing);

  // ê·¸ë¦¬ë“œê°€ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡ ì‹œì‘ ìœ„ì¹˜ ê³„ì‚°
  const gridWidth = (cols - 1) * spacing;
  const gridHeight = (rows - 1) * spacing;
  const startX = (width - gridWidth) / 2;
  const startY = (height - gridHeight) / 2;

  for (let i = 0; i < cols; i++) {
    for (let j = 0; j < rows; j++) {
      const x = startX + i * spacing;
      const y = startY + j * spacing;
      const diamond = new Diamond(x, y, diamondSize, id);
      diamond.startAnimation();
      diamonds.push(diamond);
    }
  }
}

/**
 * @brief ê°€ì¥ ìµœê·¼ì— ìƒì„±ëœ ë§ˆë¦„ëª¨ ê·¸ë£¹ì„ ì°¾ì•„ ì¶•ì†Œ/ì œê±° ì• ë‹ˆë©”ì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.
 */
function shrinkLatestDiamonds() {
  if (spreadCount === 0) return; // ìƒì„±ëœ ë§ˆë¦„ëª¨ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ

  for (let diamond of diamonds) {
    // í˜„ì¬ ì œìŠ¤ì²˜ íšŸìˆ˜ì™€ ë™ì¼í•œ IDë¥¼ ê°€ì§„ ë§ˆë¦„ëª¨ë§Œ ëŒ€ìƒìœ¼ë¡œ í•¨
    if (diamond.spreadNumber === spreadCount && !diamond.isShrinking) {
      diamond.startShrinking();
    }
  }
}

/**
 * @brief diamonds ë°°ì—´ì„ ìˆœíšŒí•˜ë©° ê° ë§ˆë¦„ëª¨ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ê·¸ë¦½ë‹ˆë‹¤.
 */
function updateAndDrawDiamonds() {
  // ì‚´ì•„ìˆëŠ” ë§ˆë¦„ëª¨ë§Œ í•„í„°ë§ (ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ ì‚­ì œë  ëŒ€ìƒì€ ì œì™¸)
  diamonds = diamonds.filter(diamond => !diamond.shouldDelete);

  for (let diamond of diamonds) {
    diamond.update();
    diamond.draw();
  }
}


// Easing í•¨ìˆ˜ (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼)
function easeInOutExpo(x) {
  return x === 0 ? 0 : x === 1 ? 1 : x < 0.5 ? Math.pow(2, 20 * x - 10) / 2 : (2 - Math.pow(2, -20 * x + 10)) / 2;
}


// --- Diamond Class (ë§ˆë¦„ëª¨ ê°ì²´) ---
// (ê¸°ì¡´ ì½”ë“œì™€ ëŒ€ë¶€ë¶„ ë™ì¼í•˜ë©°, ë¡œì§ ë³€ê²½ ì—†ìŒ)
class Diamond {
  constructor(centerX, centerY, size, spreadNumber) {
    this.centerX = centerX;
    this.centerY = centerY;
    this.size = size;
    this.spreadNumber = spreadNumber; // ìƒì„±ëœ ì œìŠ¤ì²˜ì˜ ID
    this.currentSize = 0;
    this.targetSize = size;
    this.animationTime = 0;
    this.animationDuration = 60; // 60í”„ë ˆì„ (ì•½ 1ì´ˆ) ë™ì•ˆ ì• ë‹ˆë©”ì´ì…˜
    this.isAnimating = false;
    this.isShrinking = false;
    this.shouldDelete = false;
  }

  draw() {
    push();
    fill(0);
    noStroke();
    translate(this.centerX, this.centerY);
    rotate(PI / 4); // 45ë„ íšŒì „í•˜ì—¬ ë§ˆë¦„ëª¨ Ø´ÙƒÙ„ ë§Œë“¤ê¸°
    rectMode(CENTER);
    rect(0, 0, this.currentSize * 1.5, this.currentSize * 1.5); // ë§ˆë¦„ëª¨ í¬ê¸° ì¡°ì ˆ
    pop();
  }

  startAnimation() {
    this.isAnimating = true;
    this.animationTime = 0;
  }

  startShrinking() {
    this.isShrinking = true;
    this.animationTime = 0;
    this.targetSize = this.currentSize; // í˜„ì¬ í¬ê¸°ì—ì„œë¶€í„° ì¤„ì–´ë“¤ë„ë¡ ì„¤ì •
  }

  update() {
    if (this.isAnimating) {
      this.animationTime++;
      let progress = this.animationTime / this.animationDuration;
      if (progress >= 1) {
        progress = 1;
        this.isAnimating = false;
      }
      this.currentSize = lerp(0, this.targetSize, easeInOutExpo(progress));
    }

    if (this.isShrinking) {
      this.animationTime++;
      let progress = this.animationTime / this.animationDuration;
      if (progress >= 1) {
        progress = 1;
        this.isShrinking = false;
        this.shouldDelete = true; // ì• ë‹ˆë©”ì´ì…˜ ëë‚˜ë©´ ì‚­ì œ ëŒ€ìƒìœ¼ë¡œ í‘œì‹œ
      }
      this.currentSize = lerp(this.targetSize, 0, easeInOutExpo(progress));
    }
  }
}